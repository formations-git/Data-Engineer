<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Guide ‚Äî Suivi Et Analyse Des Requ√™tes Et Co√ªts Sur Gcp</title>
    <!-- Int√©gration du style et script Highlight.js avec th√®me fonc√© -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body {
            font-family: Inter, Roboto, Arial;
            max-width: 980px;
            margin: 28px auto;
            padding: 20px;
            line-height: 1.55;
            color: #f1f1f1;
            background: #0b1d3a;
        }
        h1, h2 {
            color: #f8f8f2;
        }
        pre {
            background-color: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            overflow-x: auto;
            margin: 12px 0;
        }
        .hljs {
            background-color: #033466 !important;
            padding: 10px !important;
            border-radius: 4px !important;
        }
        code {
            font-family: Consolas, Monaco, monospace;
            font-size: 14px;
            color: #f8f8f2;
        }
        p, li {
            color: #cccccc;
        }
        .hint {
            background: #163d66;
            border-left: 4px solid #4da6ff;
            padding: 12px;
            margin: 12px 0;
            border-radius: 6px;
            color: #fff;
        }
        .section {
            margin-bottom: 20px;
        }
        ul { margin-left: 1.25em; }
        .small { font-size: 90%; color: #bfcbdc; }
    </style>
</head>
<body>

<h1>Suivi et analyse des requ√™tes et co√ªts sur GCP</h1>

<div class="section">
<h2>1Ô∏è‚É£ Cr√©er un projet pour stocker les donn√©es de facturation</h2>
<ul>
<li>Ouvre la <strong>Console GCP ‚Üí Gestion des projets ‚Üí Cr√©er un projet</strong>.</li>
<li>Donne-lui un nom clair, par exemple <code>billing-export</code>.</li>
<li>Assure-toi que <strong>la facturation est activ√©e</strong> pour ce projet :</li>
<ul>
<li>Menu : <strong>Facturation ‚Üí Associer un compte de facturation</strong>.</li>
</ul>
</ul>
</div>

<div class="section">
<h2>2Ô∏è‚É£ Configurer les autorisations</h2>
<p>Pour que le transfert Cloud Billing ‚Üí BigQuery fonctionne :</p>
<ul>
<li>L‚Äôutilisateur qui configure l‚Äôexport doit avoir les r√¥les :</li>
<ul>
<li><code>roles/bigquery.admin</code> sur le projet cible</li>
<li><code>roles/billing.admin</code> ou <code>roles/billing.user</code> sur le compte de facturation √† exporter</li>
</ul>
<li>V√©rifie dans <strong>IAM & Admin ‚Üí IAM</strong> que les r√¥les sont bien attribu√©s.</li>
</ul>
</div>

<div class="section">
<h2>3Ô∏è‚É£ Activer l‚ÄôAPI BigQuery Data Transfer Service</h2>
<ul>
<li>Menu : <strong>API & Services ‚Üí Biblioth√®que</strong></li>
<li>Rechercher <strong>BigQuery Data Transfer Service</strong></li>
<li>Cliquer sur <strong>Activer</strong></li>
</ul>
<div class="hint">üí° Cette API est n√©cessaire pour cr√©er un transfert automatique Cloud Billing ‚Üí BigQuery.</div>
</div>

<div class="section">
<h2>4Ô∏è‚É£ Cr√©er un ensemble de donn√©es BigQuery</h2>
<ul>
<li>Menu : <strong>BigQuery ‚Üí S√©lectionner le projet cible ‚Üí Cr√©er un ensemble de donn√©es</strong></li>
<li>Donne-lui un nom, ex : <code>billing_data</code></li>
<li>Choisis la <strong>localisation</strong> (r√©gion) o√π les donn√©es seront stock√©es</li>
<li>Laisse les autres options par d√©faut</li>
</ul>
</div>

<div class="section">
<h2>5Ô∏è‚É£ Configurer l‚Äôexportation Cloud Billing</h2>
<ul>
<li>Menu : <strong>Facturation ‚Üí Param√®tres de facturation ‚Üí Exporter vers BigQuery</strong></li>
<li>Cliquer sur <strong>Cr√©er un export</strong></li>
<li>S√©lectionner :</li>
<ul>
<li>Compte de facturation √† exporter</li>
<li>Projet et ensemble de donn√©es BigQuery cr√©√© (<code>billing_data</code>)</li>
</ul>
<li>S√©lectionner le type de donn√©es :</li>
<ul>
<li>Donn√©es de co√ªt d√©taill√©es (recommand√© pour suivi pr√©cis)</li>
<li>Donn√©es de tarification (optionnel, si besoin de r√©f√©rence sur tarifs)</li>
</ul>
<li>Cliquer sur <strong>Cr√©er</strong></li>
</ul>
</div>

<div class="section">
<h2>6Ô∏è‚É£ Suivre les m√©triques et la consommation dans Google Cloud Console</h2>
<ul>
<li>Console GCP ‚Üí <strong>Facturation ‚Üí Vue d‚Äôensemble</strong></li>
<li>Filtrer par produit/service (ex : BigQuery)</li>
<li>Visualiser :</li>
<ul>
<li>Nombre de requ√™tes ex√©cut√©es</li>
<li>Consommation (bytes trait√©s pour BigQuery)</li>
<li>Co√ªt associ√©</li>
</ul>
<li>Cr√©er des <strong>alertes budg√©taires</strong> pour pr√©venir les d√©passements :</li>
<ul>
<li>Facturation ‚Üí Budgets et alertes ‚Üí Cr√©er un budget</li>
</ul>
</ul>
</div>

<div class="section">
<h2>7Ô∏è‚É£ Analyser l‚Äôhistorique des requ√™tes BigQuery</h2>

<h3>7.1 Job History via la Console</h3>
<ul>
<li>BigQuery ‚Üí Projet ‚Üí <strong>Historique des requ√™tes</strong></li>
<li>Informations disponibles :</li>
<ul>
<li>Utilisateur ayant ex√©cut√© la requ√™te</li>
<li>Requ√™te SQL compl√®te</li>
<li>Date, ressources utilis√©es (bytes, dur√©e, co√ªt estim√©)</li>
</ul>
<li>Filtrage possible par <strong>date, utilisateur ou dataset</strong></li>
</ul>

<h3>7.2 Requ√™te SQL sur INFORMATION_SCHEMA</h3>
<pre><code class="sql">SELECT
  creation_time,
  user_email,
  query,
  total_bytes_processed,
  total_slot_ms,
  state
FROM
  `region-us`.INFORMATION_SCHEMA.JOBS_BY_PROJECT
WHERE
  job_type = 'QUERY'
  AND creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
ORDER BY
  creation_time DESC
LIMIT 100;
</code></pre>
<ul>
<li>Remplacer <code>region-us</code> par la r√©gion de votre projet</li>
<li>Permet de lister toutes les requ√™tes ex√©cut√©es r√©cemment, avec utilisateur et consommation</li>
</ul>
</div>

<div class="section">
<h2>8Ô∏è‚É£ Suivre la consommation par service via BigQuery</h2>
<p>Une fois l‚Äôexport Cloud Billing configur√©, interroger les donn√©es pour suivre les co√ªts et la consommation :</p>
<pre><code class="sql">SELECT
  service.description AS service,
  usage_start_time,
  SUM(cost) AS total_cost,
  SUM(usage.amount) AS total_usage
FROM
  `billing_data.gcp_billing_export_v1_*`
WHERE
  service.description = 'BigQuery'
GROUP BY
  service, usage_start_time
ORDER BY
  usage_start_time DESC;
</code></pre>
<ul>
<li><code>billing_data</code> le nom de dataset BigQuery cr√©er pour int√©grer les donn√©es de facturation </li>
<li>Permet de suivre le <strong>co√ªt et la consommation quotidienne par service</strong></li>
</ul>
</div>

<div class="section">
<h2>9Ô∏è‚É£ Astuce avanc√©e</h2>
<ul>
<li>Combiner :</li>
<ul>
<li>Export Cloud Billing ‚Üí BigQuery</li>
<li>Requ√™tes INFORMATION_SCHEMA pour l‚Äôhistorique des requ√™tes</li>
<li>Dashboards dans <strong>Data Studio / Looker</strong> pour visualiser co√ªts et consommation dans l'√©tape 4 :Cr√©er un ensemble de donn√©es BigQuery</li>
<li>Alertes budg√©taires pour pr√©venir les d√©passements</li>
</ul>
</ul>
</div>

</body>
</html>
