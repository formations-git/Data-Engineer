<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Programmation et gestion des relances dans Airflow avec GCP</title>
    <!-- Intégration du style et script Highlight.js avec thème foncé -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body {
            font-family: Inter, Roboto, Arial; /* Liste de polices par ordre de priorité */
            max-width: 980px;                  /* Largeur maximale du contenu pour éviter les lignes trop longues */
            margin: 28px auto;                 /* Centrage horizontal + espace vertical */
            padding: 20px;                     /* Espace interne autour du texte */
            line-height: 1.55;                 /* Hauteur de ligne pour meilleure lisibilité */
            color: #f1f1f1;                    /* Couleur claire du texte */
            background: #0b1d3a;               /* Fond bleu foncé de la page */
        }
        h1, h2 {
            color: #f8f8f2;
        }
        pre {
            background-color: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            overflow-x: auto;
        }
        .hljs {
            background-color: #033466 !important; /* bleu moins foncé */
            padding: 10px !important;
            border-radius: 4px !important;
        }
        code {
            font-family: Consolas, Monaco, monospace;
            font-size: 14px;
            color: #f8f8f2;
        }
        p, li {
            color: #cccccc;
        }
        .hint {
      background: #163d66;            /* Fond bleu-gris plus clair pour les encadrés */
      border-left: 4px solid #4da6ff; /* Trait bleu à gauche (effet “note”) */
      padding: 12px;                  /* Espacement interne */
      margin: 12px 0;                 /* Marges au-dessus et en dessous */
      border-radius: 6px;             /* Coins arrondis */
      color: #fff;                    /* Texte blanc */
    }
    </style>
</head>
<body>
    <h1>Utilisation d'Airflow avec GCP</h1>
    <h2>1. Programmer le lancement quotidien à 6h du matin</h2>
    <p>Pour exécuter un DAG Airflow chaque jour à 6h du matin dans Cloud Composer (GCP), il faut définir le <code>schedule_interval</code> avec une expression cron, et un <code>start_date</code> :</p>
    <pre><code class="language-python">from datetime import datetime
from airflow import DAG
dag = DAG(
    'mon_dag',
    schedule_interval='0 6 * * *',  # Tous les jours à 6h du matin
    start_date=datetime(2025, 9, 18, 6, 0),
    catchup=False  # pour éviter l'exécution des runs manqués
)
</code></pre>
    <p>Cette configuration garantit que le DAG sera lancé chaque jour à 6h du matin à partir de la date spécifiée.</p>
    <h2>2. Relancer automatiquement une étape en cas d'échec</h2>
    <p>Pour que Airflow relance automatiquement une tâche qui a échoué, il faut configurer les paramètres de retry dans les arguments par défaut de la DAG ou sur chaque tâche :</p>
    <pre><code class="language-python">from datetime import datetime, timedelta
from airflow import DAG
from airflow.operators.dummy import DummyOperator
default_args = {
    'owner': 'airflow',
    'start_date': datetime(2025, 9, 18),
    'retries': 3,  # Nombre de relances en cas d'échec
    'retry_delay': timedelta(minutes=5),  # Délai entre chaque relance
}
dag = DAG('mon_dag', default_args=default_args, schedule_interval='0 6 * * *', catchup=False)
task1 = DummyOperator(task_id='etape_1', dag=dag)
task2 = DummyOperator(task_id='etape_2', dag=dag)
task1 >> task2
</code></pre>
    <p>Avec cette configuration, si <code>etape_2</code> échoue, Airflow la relancera jusqu'à 3 fois, avec un délai de 5 minutes entre chaque tentative.</p>
    <p>Ce mécanisme est la méthode standard pour gérer les erreurs temporaires et assurer la reprise automatique des traitements.</p>
    <h2>3. Ajouter une étape de relance dans votre DAG personnalisé</h2>
    <p>Pour intégrer une logique de relance automatique dans votre DAG personnalisé, modifiez la définition des arguments par défaut et ajoutez <code>retries</code> et <code>retry_delay</code> à vos opérateurs critiques, par exemple :</p>
    <pre><code class="language-python">from datetime import timedelta
args = {
    "retries": 3,
    "retry_delay": timedelta(minutes=5)
}
with models.DAG(f'{dag_name}_{AIRFLOW_VAR_ENVIRONMENT}',
    schedule_interval=None,
    start_date=datetime(2021, 2, 3),
    default_args=args,
    catchup=False,
    max_active_runs=1,
    dagrun_timeout=timedelta(minutes=60),
    tags=tags
) as dag:
    # ... votre code ...
    for j, l in enumerate(L):
        load_tbl = bigquery_operator.BigQueryOperator(
            task_id=f'{l[0]}',
            sql=f'./sql/{l[2]}/{l[0]}.sql',
            use_legacy_sql=False,
            params={'environment': Variable.get('environment')},
            retries=args['retries'],
            retry_delay=args['retry_delay']
        )
        # ... logique de dépendance ...
        if l[1]:  # Si contrôle est nécessaire
            control_task = ControlOperator(
                task_id=f'control_{l[0]}',
                dataset_name='rni-projet_vente-gbl-ww',
                yaml_path=f'gcs/dags/{project_path}/controls/usecase/{l[0]}.yml',
                retries=args['retries'],
                retry_delay=args['retry_delay']
            )
            load_tbl >> control_task
            list_tasks_current_group.append(control_task)
        else:
            list_tasks_current_group.append(load_tbl)
</code></pre>
    <p>Cette modification assure que vos tâches Critiques seront relancées automatiquement jusqu'à 3 fois avec 5 minutes d'intervalle en cas d'échec.</p>
</body>
</html>
